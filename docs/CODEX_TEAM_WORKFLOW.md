# 팀 협업 오케스트레이션 기능 스펙

이 문서는 `oh-my-claudecode` 기반 팀 실행을 기능 중심으로 정리한 실무 사양이다.  
목표는 `작업 분할 → 실행 → 검증 → 실패 복구 → 정리`를 파일 기반 상태로 일관되게 수행하는 것이다.

## 1. 목적

- 사용자의 단일 요청을 다수 worker로 분할 처리한다.
- 실행 완료를 수치적으로 판정 가능한 상태 조건으로 판단한다.
- 비정상 종료나 중단 시에도 재개/복구가 가능하도록 상태를 보존한다.
- 종료 시 잔존 자원과 상태를 정리한다.

## 2. 기능 요구사항

1. 팀 시작
   - 명령으로 팀 실행을 시작할 수 있어야 한다.
   - 입력에서 worker 수, worker 타입, 작업 제목을 파싱해 팀 이름을 생성한다.
2. 작업 분할
   - 요청을 실행 가능한 `Task` 단위로 분해한다.
   - 각 Task는 소유 경계(파일/디렉터리/기능)와 `blocked_by` 의존성을 포함한다.
3. 실행
   - Task를 worker에 배정(`assignTask`)하고, 필요 시 재배정한다.
   - worker는 독립 세션에서 작업을 수행하고 상태 채널로 진척을 올린다.
4. 상태 관리
   - 팀/Task/worker 상태를 파일로 영속화한다.
   - 상태 항목은 `current_phase`, task 상태(`pending`, `in_progress`, `blocked`, `completed`, `failed`), 실패 횟수, heartbeat 정보를 포함한다.
5. 완료 판정
   - 작업이 더 이상 진행 대상이 없어야 한다.
   - 검증 게이트(테스트/빌드/정적 점검 등) 결과가 통과여야 한다.
   - 실패 정책에 따라 허용 실패가 없거나, 승인된 예외가 명시되어야 한다.
6. 검증/수정 루프
   - verify 단계로 결과를 확인한다.
   - 실패 시 fix 단계로 되돌려 수정 후 재검증한다.
   - fix 반복 횟수 상한을 두어 무한 루프를 막는다.
7. 모니터링
   - 주기적으로 작업/worker 상태를 집계한다.
   - 비활성 worker, heartbeat 정체(worker non-reporting), 죽은 worker를 감지해 조치 대상 표시한다.
8. 종료/정리
   - 정상 종료 시 shutdown-ack를 받아 pane/세션/상태를 정리한다.
   - 실패 종료 시에도 최종 원인과 상태를 남겨 추적 가능하게 한다.

## 3. 실행 흐름(기능 관점)

1. plan/범위 정리
2. task 분해 및 의존성 설정
3. team-exec 실행
4. team-verify로 게이트 확인
5. 실패면 team-fix 후 재실행
6. 완료면 정리

위 흐름에서 `pending=0`, `blocked=0`, `in_progress=0`은 기본 완료 후보 조건이며  
실제 성공 전환은 verify 통과와 실패 정책 준수까지 포함한다.

## 4. 상태 판정 규칙

- Task 집계 기준
  - `total`, `pending`, `blocked`, `in_progress`, `completed`, `failed`를 항상 계산한다.
- 종료 조건 제안
  - 필수: `pending=0`, `in_progress=0`, `blocked=0`
  - 권장: `failed=0` (또는 사전 승인된 예외)
- 예외:
  - 단기적으로 worker가 응답하지 않더라도 heartbeat가 살아 있으면 waiting 상태로 구분.
  - 고장 worker는 dead로 분류 후 재배정 후보로 이동.

## 5. 역할과 책임

- Planner/PRD: 요구사항 분해, 범위·의존성 정의
- Executor: 실제 작업 수행, 결과 산출
- Verifier: 테스트/리뷰/정적검사 실행
- Fix 루프: 실패 항목 수정 및 재검증
- Team 관리자: 실행/모니터링/재시작/정리 총괄

## 6. 체크리스트

- [ ] 작업 단위가 겹치지 않게 분해되었는가?
- [ ] `blocked_by` 의존성이 명확한가?
- [ ] task state transition과 verify 게이트가 정의되었는가?
- [ ] 종료 조건(`pending/blocked/in_progress`) 검증이 자동화되었는가?
- [ ] dead/non-reporting worker 대응이 자동 재배정으로 이어지는가?
- [ ] 종료 시 환경 정리(shutdown + 상태 정리)가 수행되었는가?
- [ ] 실패 이력과 원인 로그가 남아 재개 가능한가?

## 7. 운영 원칙

- 종료는 명령 응답이 아니라 `상태 + 검증 증거 + 정리`가 모두 충족될 때만 허용한다.
- 상태는 파일에 보존되어야 하며, 중단 시 복구 가능한 지점에서 재개할 수 있어야 한다.
- 실패 재시도는 상한을 넘기면 강제 실패로 전환해 의사결정을 명시한다.

## 8. 하위 문서

- 동기화 파일 형식, 이벤트, 상태 경로, 재개/복구 동작은 `docs/oh-my-codex-team-workflow-sync.md`를 따른다.
